<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Fast Virtualization with QEMU</title>
    <meta name="description" content="Most of you are familiar with Full Virtualization solutions before like VMware Workstation, VirtualBox, and Parallels. In this post, I'll re-introduce you to another, arguably faster, way of doing things....">
    <meta name="author"      content="Rommel Martinez">
    <meta name="keywords"    content="virtualization, sysadmin">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">

    <!-- <link rel="icon"      href="/favicon.ico"> -->

    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link rel="canonical" href="http://ebzzry.github.io/blog/2015/06/15/fast-virtualization-with-qemu/">
    <!-- CSS -->
    <!-- <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css"> -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <!-- Feeds -->
    <link ref="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link ref="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-xxxxx']);
      _gaq.push(['_setDomainName', 'example.com']);
      _gaq.push(['_trackPageview']);
      setTimeout(function(){_gaq.push(['_trackEvent', '30_seconds', 'read'])}, 30000); // http://drawingablank.me/blog/fix-your-bounce-rate.html
      (function() {
          var ga = document.createElement('script');
          ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body id="wrapper">
    <!-- A standard Twitter Bootstrap nav bar -->
    <header class="navbar navbar-default navbar-inverse"
            role="banner">
      <div class="container">
        <div class="navbar-header">
          <button type="button"
                  class="navbar-toggle"
                  data-toggle="collapse"
                  data-target=".our-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <!-- <a href="/index.html" class="navbar-brand">Home</a> -->
          <!-- <a href="/index.html">Home</a> -->
        </div>
        <div class="collapse navbar-collapse our-nav-collapse" role="navigation">
          <ul class="nav navbar-nav">

            <li>
              <a href="/index.html">Home</a>
            </li> 
            <li>
              <a href="/about.html">About</a>
            </li> 
            <!-- <li><a href="/feeds/all.atom.xml">Atom</a></li> -->
            <li><a href="/feeds/all.rss.xml">RSS</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags/backups.html">backups</a></li>

<li><a href="/tags/compsci.html">compsci</a></li>

<li><a href="/tags/emacs.html">emacs</a></li>

<li><a href="/tags/essays.html">essays</a></li>

<li><a href="/tags/mail.html">mail</a></li>

<li><a href="/tags/programming.html">programming</a></li>

<li><a href="/tags/racket.html">racket</a></li>

<li><a href="/tags/scheme.html">scheme</a></li>

<li><a href="/tags/security.html">security</a></li>

<li><a href="/tags/sysadmin.html">sysadmin</a></li>

<li><a href="/tags/virtualization.html">virtualization</a></li>

<li><a href="/tags/web.html">web</a></li>
              </ul>
            </li>
          </ul>
        </div>
    </header>
    <div class="container">
      <div class="row">

        <!-- Main column -->
        <div id="content" class="col-md-12">





          <article>
  <header>
    <h1>Fast Virtualization with QEMU</h1>

<p class="date-and-tags">
 <time datetime="2015-06-15" pubdate="true">2015-06-15</time> :: <span class="tags"><a href="/tags/virtualization.html">virtualization</a>, <a href="/tags/sysadmin.html">sysadmin</a></span></p>
  </header>

<p>Most of you are familiar with <a href="https://en.wikipedia.org/wiki/Full_virtualization">Full Virtualization</a> solutions before like VMware Workstation, VirtualBox, and Parallels. In this post, I&rsquo;ll re-introduce you to another, arguably faster, way of doing things.</p>
<!-- more-->

<h1 id="preparation">Preparation</h1>

<h2 id="hardware">Hardware</h2>

<p>One of the first things that we need to do is to enable <a href="https://en.wikipedia.org/wiki/Hardware-assisted_virtualization">Hardware-assisted virtualization</a>, also called accelerated virtualization, in your hardware. If your CPU was made before 2006, chances are, this feature won&rsquo;t be present on your chip. Also, take note that this step is not compulsory to make use of the virtualization solution described in this post, but it will <strong>significantly</strong> speed things up. To enable accelerated virtualization, go into BIOS/UEFI, and look for the knob that enables this feature. The name into which it goes is different from manufacturer to manufacturer. You can verify on the command line if your system indeed recognizes it.</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> egrep <span class="s1">&#39;(vmx|svm)&#39;</span> /proc/cpuinfo
</pre></div>
</td></tr></tbody></table>
</div>

<p>If it returns some text, then we&rsquo;re good.</p>

<h2 id="software">Software</h2>

<p>Next, we need to install the essential applications. The commands below are for NixOS, so change it accordingly for your system.</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> nix-env -i qemu vde2 spice
</pre></div>
</td></tr></tbody></table>
</div>

<p>This will install the <a href="http://wiki.qemu.org/">QEMU</a> (pronounced as kee-moo) hypervisor, <a href="http://vde.sourceforge.net/">VDE</a> tools, and <a href="http://www.spice-space.org/">SPICE</a> support. QEMU, at least during its early days had the <em>meh</em> impression &mdash; it is OK, but not stellar. Since version 0.10.1, QEMU started supporting <a href="http://www.linux-kvm.org/">KVM</a>, a virtualization subsystem for Linux, that provides near-native virtualization performance using hardware-assisted virtualization. It even rivals the performance of the virtualization solutions mentioned above.</p>

<p>Other suites offer the option of connecting to the guest machine&rsquo;s display via VNC. The problem is that, it&rsquo;s slow and clunky. The response time is just horrible. Using the <a href="http://www.spice-space.org/">SPICE</a> protocol, not only does it makes things faster, but it makes other things possible. Take note that SPICE is not a replacement for <a href="https://en.wikipedia.org/wiki/Virtual_Network_Computing">VNC</a>, but rather, it a different way of meeting our goals.</p>

<h1 id="configuration">Configuration</h1>

<h2 id="images">Images</h2>

<p>QEMU supports an array of image types, however the <a href="https://en.wikipedia.org/wiki/Qcow">QCOW2</a> format is the most flexible, and feature-rich, for QEMU use.</p>

<p>If you have an existing VirtualBox file (VDI), you can convert it to QCOW2 with:</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> qemu-img convert -f vdi -O qcow2 vm.vdi vm.qcow2
</pre></div>
</td></tr></tbody></table>
</div>

<p>However, if you don&rsquo;t have an image, yet, you can create one with:</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> qemu-img create -f qcow2 vm.qcow2 20G
</pre></div>
</td></tr></tbody></table>
</div>

<p>The last step creates a 20GB image, that is named <strong>vm.qcow2</strong>. Take note that the extension name doesn&rsquo;t really matter &mdash; you can name your image as <strong>index.html</strong>, but that wouldn&rsquo;t make a lot of sense, right? :)</p>

<h2 id="networking">Networking</h2>

<p>QEMU <a href="http://wiki.qemu.org/Documentation/Networking">supports</a> several ways of setting up networking for its guest, but for this post we&rsquo;re going to use VDE.</p>

<p>We need to run several commands to prep the networking environment. Ideally, you&rsquo;d want to save these in a shell function, or a shell script:</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> sudo vde_switch -tap tap0 -mod <span class="m">660</span> -group kvm -daemon
<span class="gp">$</span> sudo ip addr add 10.0.2.1/24 dev tap0
<span class="gp">$</span> sudo ip link <span class="nb">set </span>dev tap0 up
<span class="gp">$</span> sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1
<span class="gp">$</span> sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
</pre></div>
</td></tr></tbody></table>
</div>

<p>The above commands will:</p>

<blockquote>
 <ol>
  <li>Create a VDE device</li>
  <li>Configure the TCP/IP options for that device.</li>
  <li>Enable the VDE device.</li>
  <li>Enable packet forwarding on the host OS.</li>
  <li>Setup the routing configuration.</li></ol></blockquote>

<h1 id="execution">Execution</h1>

<h2 id="load-the-image">Load the image</h2>

<p>We now need to invoke <strong>qemu-kvm</strong>, the command that will launch everything up. The name of the command may differ with the one installed on your system.</p>

<p>If you&rsquo;re installing an OS from a bootable image, usually an ISO file, run:</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> qemu-kvm -cpu host -m 2G -net nic,model<span class="o">=</span>virtio -net vde <span class="se">\</span>
<span class="go">-device AC97,addr=0x18 -vga qxl \</span>
<span class="go">-spice port=9999,addr=127.0.0.1,password=mysecretkey \</span>
<span class="go">-boot once=d -cdrom installer.iso \</span>
<span class="go">vm.qcow2</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>On subsequent uses:</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> qemu-kvm -cpu host -m 2G -net nic,model<span class="o">=</span>virtio -net vde <span class="se">\</span>
<span class="go">-device AC97,addr=0x18 -vga qxl \</span>
<span class="go">-spice port=9999,addr=127.0.0.1,password=mysecretkey \</span>
<span class="go">vm.qcow2</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Let&rsquo;s break that down:</p>

<pre><code>-cpu host</code></pre>

<p>Use the KVM processor with all the supported features</p>

<pre><code>-m 2G</code></pre>

<p>Allocate 2GB of host memory for the guest. Adjust as necessary.</p>

<pre><code>-net nic,model=virtio -net vde</code></pre>

<p>Create a virtual NIC, and enable VDE networking</p>

<pre><code>-device AC97,addr=0x18</code></pre>

<p>Specify the audio adapter to emulate. <a href="https://en.wikipedia.org/wiki/AC%2797">AC97</a> works reasonably well for most configurations.</p>

<pre><code>-vga qxl</code></pre>

<p>Specify the video adapter to emulate. Use QXL when using SPICE</p>

<pre><code>-spice addr=127.0.0.1,port=9999,password=mysecretkey</code></pre>

<p>Specify the options for SPICE, separated by commas. <strong>addr</strong> and <strong>port</strong> are the IP address and TCP port that SPICE will listen on. Ideally, access to that port must be properly configured, and secured. <strong>password</strong> is key that will be used by the SPICE client, <code>spicec</code>, to connect to the guest display later.</p>

<pre><code>-boot once=d -cdrom installer.iso</code></pre>

<p>Boot initially from <code>installer.iso</code>, then on subsequent boots, boot in the normal order.</p>

<p>Running the <strong>qemu-kvm</strong> command above will load the image, but we won&rsquo;t be able to view the display, yet.</p>

<h2 id="connect-to-the-spice-display">Connect to the SPICE display</h2>

<p>To be able to use the guest machine&rsquo;s display, we need to connect to the SPICE server, using the SPICE client <strong>spicec</strong>:</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> spicec -h 127.0.0.1 -p <span class="m">5901</span> -w mysecretkey
</pre></div>
</td></tr></tbody></table>
</div>

<p>Take note that closing the spicec window will not kill the QEMU session. If the guest OS captures the mouse input, press <strong>Shift+F12</strong>, to get out of it.</p>

<h2 id="configure-guest-networking">Configure guest networking</h2>

<p>Next, we need to properly configure the network configuration of the guest OS so that it can connect to the rest of the local network, and to the internet if the host machine has access to it.</p>

<pre><code># IP address (any value from 10.0.2.2 to 10.0.2.254)
10.0.2.2

# Gateway (the host machines' address, from the guest machine's view.)
10.0.2.1

# DNS (Google's DNS service)
8.8.8.8
8.8.4.4</code></pre>

<h1 id="closing-the-curtains">Closing the Curtains</h1>

<h2 id="restore-networking">Restore networking</h2>

<p>If you want to explicitly revert the network configuration, do the following.</p>

<div class="brush: console">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="gp">$</span> sudo iptables -t nat -D POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
<span class="gp">$</span> sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>0
<span class="gp">$</span> sudo ip link <span class="nb">set </span>dev tap0 down
<span class="gp">$</span> sudo ip link delete tap0
<span class="gp">$</span> sudo pkill -9 vde_switch
<span class="gp">$</span> sudo rm -f /run/vde.ctl/ctl
</pre></div>
</td></tr></tbody></table>
</div>

<p>The above commands will:</p>

<blockquote>
 <ol>
  <li>Revert the routing configuration.</li>
  <li>Disable packet forwarding.</li>
  <li>Disable the VDE device.</li>
  <li>Delete the VDE device.</li>
  <li>Kill the VDE process.</li>
  <li>Remove control files.</li></ol></blockquote>

<h1 id="conclusion">Conclusion</h1>

<p>QEMU supports a myriad of cool options that were not even discussed here, including saving and loading states (snapshots), creating screen and audio grabs, and a whole lot more. To learn more about them, click <a href="http://wiki.qemu-project.org/Main_Page">here</a>.</p>

<p>QEMU with KVM is a powerful, fast, and flexible solution for doing <a href="https://en.wikipedia.org/wiki/Full_virtualization">Full Virtualization</a>. At least in my case, it out-performs the well-known options in the market. If you want to contribute to this project, head over to their <a href="https://github.com/qemu/qemu">GitHub page</a>.</p>

<p>I hope this post helped you, in one way or another, learn more about QEMU and what it has to offer. Ciao!</p>
  <footer>
    <script type="text/javascript">
      !function(d,s,id){
          var js,fjs=d.getElementsByTagName(s)[0];
          if(!d.getElementById(id)){
              js=d.createElement(s);
              js.id=id;
              js.src="//platform.twitter.com/widgets.js";
              fjs.parentNode.insertBefore(js,fjs);
          }
      }(document,"script","twitter-wjs");
    </script>
    <a href="https://twitter.com/share"
       class="twitter-share-button"
       data-url="http://ebzzry.github.io/blog/2015/06/15/fast-virtualization-with-qemu/"
       data-dnt="true">
      "Tweet"</a>
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
    <g:plusone size="medium" href="http://ebzzry.github.io/blog/2015/06/15/fast-virtualization-with-qemu/"></g:plusone>
    <script type="text/javascript">
      var disqus_shortname = 'ebzzrygithubio';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <div id="disqus_thread"></div>
    <ul class="pager">

    <li class="next">
      <a href="/blog/2015/06/12/a-lambda-calculus-primer/"><em>A Lambda Calculus Primer</em> &rarr;</a>
    </li>
    </ul>
  </footer>
</article>
        </div>
      </div>
      <footer>
        <hr />
        <!-- <p><a href="https://twitter.com/ebzzry"
                   class="twitter-follow-button"
                   data-show-count="false"
                   data-lang="en">
                  "Follow ebzzry"
                </a>
                <script type="text/javascript">
                  !function(d,s,id){
                      var js,fjs=d.getElementsByTagName(s)[0];
                      if(!d.getElementById(id)){
                          js=d.createElement(s);
                          js.id=id;
                          js.src="//platform.twitter.com/widgets.js";
                          fjs.parentNode.insertBefore(js,fjs);
                      }
                  }(document,"script","twitter-wjs");
                </script></p> -->
        <p>Site created with
          <a href="http://www.racket-lang.org">Racket</a>,
          <a href="http://github.com/greghendershott/frog">Frog</a>,
          <a href="http://www.gnu.org/software/emacs/">Emacs</a>, and
          <a href="http://twitter.github.io/bootstrap">Bootstrap</a></p>
        <p><em>Copyright &copy; by <a href="http://rmm.meta.ph">Rommel M. Martinez</a></em></p>
      </footer>
    </div>
    <!-- </body> JS -->
    <script type="text/javascript" src="//code.jquery.com/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  </body>
</html>