<!DOCTYPE html>
<html lang="en"><head><title>A Gentle Introduction to Nix Flakes</title><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0,user-scalable=yes" name="viewport" /><meta content="noodp,noydir" name="robots" /><link rel='apple-touch-icon' sizes='180x180' href='/images/ico/apple-touch-icon.png'><link rel='icon' type='image/png' sizes='32x32' href='/images/ico/favicon-32x32.png'><link rel='icon' type='image/png' sizes='16x16' href='/images/ico/favicon-16x16.png'><link rel='manifest' href='/images/ico/site.webmanifest'><link rel='mask-icon' href='/images/ico/safari-pinned-tab.svg' color='#5bbad5'><link rel='shortcut icon' href='/images/ico/favicon.ico'> <meta name='msapplication-TileColor' content='#da532c'> <meta name='msapplication-config' content='/images/ico/browserconfig.xml'> <meta name='theme-color' content='#ffffff'><meta content="A Gentle Introduction to Nix Flakes" name="description" /><meta content="nix, nix flakes, darwin, nixos, linux" name="keywords" /><meta content="A Gentle Introduction to Nix Flakes" property="og:title" /><meta content="article" property="og:type" /><meta content="https://ebzzry.com/en/flakes/" property="og:url" /><meta content="https://ebzzry.com/images/ico/android-chrome-512x512.png" property="og:image" /><style media="all" type="text/css">html {    color: #333;    font-size: 1em;    font-family: Georgia, Cambria, Palatino, "Palatino Linotype", "Times New Roman", Times, serif;    line-height: 1.45;    text-align: left:    width: 100%;    max-width: 40em;    margin: 0 auto 0 auto;    padding: 0;}body {    border-top: hidden;    border-bottom: hidden;    padding: 0 1.5em 1em 1.5em;    margin: 0;}#content {    -webkit-column-count: 1;    -moz-column-count: 1;    column-count: 1;}code {    font-size: 0.9em;    font-family: "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Lucida Console", "Courier New", Courier, monospace;    color: black;    display: inline-block;}pre code {    font-size: 1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;    font-weight: normal;}kbd {    font-size: 1.1em;    padding: 0.1em 0.6em;    border: 1px solid #ccc;    font-family: monospace;    background-color: #f7f7f7;    color: #333;    -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -moz-border-radius: 3px;    -webkit-border-radius: 3px;    border-radius: 3px;    display: inline-block;    margin: 0 0.1em;    text-shadow: 0 1px 0 #fff;    white-space: nowrap;}h1, h2, h3, h4, h5, h6 {    font-family: Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans", Tahoma, Geneva, Helvetica, Arial, sans-serif;    margin-bottom: 0;}h1 {    font-size: 2.5em;    text-align: center;    border-bottom: 6px solid black;}h2 {    font-size: 2.0em;    text-align: left;    border-bottom: 2px solid black;}h3 {    font-size: 1.6em;    text-align: left;    border-bottom: 1px solid lightgrey;}h4 {    font-size: 1.5em;    text-align: left;}h5 {    font-size: 1.3em;    text-align: left;}ul, ol {    padding-left: 2em;}ul li {    list-style-type: square;}ul li li {    list-style-type: disc;}ul li li li {    list-style-type: circle;}ol li {    list-style-type: decimal;}p, para, b, strong, i, em, emph {    font-size: 1em;}blockquote {    font-size: 1.2em;    font-style: italic;    margin-left: 2em;}b, strong {    font-weight: bold;}i, em, emph {    font-style: italic;}table {    margin: 0.5em;    border-spacing: 0;    border-collapse: collapse;}th, td {    border: 1px solid lightgray;    padding-top: 0;    padding-bottom: 0;    padding-left: 0.45em;    padding-right: 0.45em;}.text-right {    text-align: right;}.text-small {    font-size: small;}.text-x-small {    font-size: x-small;}.banner {    display: block;    width: 100%;    margin-left: auto;    margin-right: auto;}.footer {    text-align: right;    float: right;    max-width: 18em;}.cc {    border-width: 0}.center {    text-align: center;}</style><style media="all" type="text/css">/* Ewan Themes -- based 99.99% from Tomorrow Night Theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Original theme - https://github.com/chriskempson/tomorrow-theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Tomorrow Comment */.hljs-comment {  color: #969896;}/* Tomorrow Red */.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo {  color: #cc6666;}/* Tomorrow Orange */.hljs-number,.hljs-preprocessor,.hljs-pragma,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant {  color: #de935f;}/* Tomorrow Yellow */.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute {  color: #f0c674;}/* Tomorrow Green */.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.hljs-name,.ruby .hljs-symbol,.xml .hljs-cdata {  color: #b5bd68;}/* Tomorrow Aqua */.hljs-title,.css .hljs-hexcolor {  color: #8abeb7;}/* Tomorrow Blue */.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title {  color: #81a2be;}/* Tomorrow Purple */.hljs-keyword,.javascript .hljs-function {  color: #b294bb;}.hljs {  display: block;  overflow-x: auto;  background: #1d1f21;  color: #c5c8c6;  padding: 0.5em;  -webkit-text-size-adjust: none;}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata {  opacity: 0.5;}pre code {    font-size: 1.1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;}</style></head><body><div id="content"><h1>A Gentle Introduction to Nix Flakes</h1><p><div class="center">English • <a href='/eo/adv360/'>Esperanto</a></div></p><blockquote><p>But every decision for something is a decision against something else.<br> —H. G. Tannhaus, Dark (2017) </p></blockquote><p><img src="/images/site/raisa-milova-eiV7yq_7dhU-unsplash-1008x250.webp" style="display: block; width: 100%; margin-left: auto; margin-right: auto;" alt="adv360" title="adv360"/></p><h2><a name="toc">Table of contents</a></h2><ul><li><a href='#introduction'>Introduction</a></li><li><a href='#basics'>Basics</a><ul><li><a href='#nixos'>NixOS</a></li><li><a href='#darwin'>Darwin</a></li></ul></li><li><a href='#flakes'>Flakes</a></li><li><a href='#closing'>Closing remarks</a></li></ul><h2><a name="introduction">Introduction</a></h2><p>When I discovered Nix almost two decades ago, I learned that there's still so much to computing than what I already know. I was blown away. It was astonishing. It was nothing short of marvel. My passion for systems administration was rekindled, again.</p><p>As someone who has spent an inordinate amount of time in the BSD-land—configuring everything by hand, memorizing all of the key places where important configuration should be—I found Nix and NixOS to be breath of fresh air.</p><p>Not long after, NixOS became my primary development machine. I could do everything with it, even using devices that were not designed from the start to be used with Linux. With the help of the official documentation and helpful articles of people who have used it before me, I was able to set it up according to my preferences. I wrote about what I have learned <a href='/en/nix'>here</a>.</p><h2><a name="basics">Basics</a></h2><h3>NixOS</h3><p>The way that I've always used my NixOS system was that, I would install user packages via <code>nix-env</code> and I'm good to go. But no matter how much I optimized the process, it was still slow and cumbersome. I found out that the system was loading more things than necessary, severely impacting performance. </p><p>I dug deeper and discovered Nix Flakes. It says on the <a href='https://wiki.nixos.org/wiki/Flakes'>wiki</a> that it is an experimental feature. I don't know exactly what that means, but it feels like an alpha feature that's already good to go.</p><p>To enable it, I edited <code>/etc/nixos/configuration.nix</code> and added the following:</p><pre><code class="conf">nix.settings.experimental-features = &#91; &quot;nix-command&quot; &quot;flakes&quot; &#93;;
</code></pre><p>then did a</p><pre><code class="sh">sudo nixos-rebuild switch
</code></pre><p>I got a new set of commands from the <code>nix</code> command, and found out that they are significant departure to the commands that I'm already acquainted with.</p><p>To install a package—say emem—without flakes and to uninstall it, run</p><pre><code class="sh">nix-env --install -A nixpkgs.emem
nix-env --uninstall emem
</code></pre><p>With flakes, to install and remove it, run</p><pre><code class="sh">nix profile install nixpkgs#emem
nix profile remove emem
</code></pre><h3>Darwin</h3><p>When I got my hands on an M1 MBP, I got naturally curious if there's a way for me to use Nix on it. Soon after, I learned about <a href='https://github.com/LnL7/nix-darwin/'>nix-darwin</a>. After about an hour of tinkering, I finally got the incantation that would build everything.</p><pre><code class="sh">darwin-rebuild switch --flake &#126;/.config/nix
</code></pre><p>Just like with flakes on NixOS, I got the new set of commads.</p><p>Most, if not all important Nix commands, have already coalesced into <code>nix</code>.  I went by fine with it for a year, until I decided that it's time to take the dive and use flakes outside of the basic configuration.</p><h2><a name="flakes">Flakes</a></h2><p>One of the things that has always bothered me was transitioning from the old mode of using <code>shell.nix</code> to create portable Nix shells, to <code>flake.nix</code>. To use flakes, you need to create the file <code>flake.nix</code>, which will be the basis of everything. The command <code>nix</code> reads this file from the current directory. The <code>init</code> subcommand creates one for us, conveniently.</p><pre><code class="sh">nix flake init
</code></pre><p>the resulting file, <code>flake.nix</code>, will look something like the following:</p><pre><code class="nix">{
  description = &quot;A very basic flake&quot;;
  inputs = {
    nixpkgs.url = &quot;github:nixos/nixpkgs?ref=nixpkgs-unstable&quot;;
  };
  outputs = { self, nixpkgs }: {
    packages.aarch64-darwin.hello = nixpkgs.legacyPackages.aarch64-darwin.hello;
    packages.aarch64-darwin.default = self.packages.aarch64-darwin.hello;
  };
}
</code></pre><p>We can see, immediately, that it is an attribute set, of three parts:</p><pre><code class="nix">{
  description = ...;
  inputs = ...;
  outputs = ...;
}
</code></pre><p><code>description</code> is self-explanatory, so we're only going to look at <code>inputs</code> and <code>outputs</code>. <code>inputs</code> specify the things that will go to the flake, while <code>outputs</code> are the ones that will produced by it, that will then be used by <code>nix</code> commands.  <code>inputs</code> itself is an attribute set, and we need first to specify the location for <code>nixpkgs</code>.</p><pre><code class="nix">inputs = {
  nixpkgs.url = &quot;github:nixos/nixpkgs?ref=nixpkgs-unstable&quot;;
}
</code></pre><p>or</p><pre><code class="nix">inputs.nixpkgs.url = &quot;github:nixos/nixpkgs?ref=nixos-unstable&quot;;
</code></pre><p>Here we're using <code>?ref=</code> to specify a branch name. You can specify other things, like a specific commit ID, with <code>?rev=</code>,</p><pre><code class="nix">inputs = {
  nixpkgs.url = &quot;github:nixos/nixpkgs?ref=nixpkgs-unstable&quot;;
  oldnixpkgs.url = &quot;github:nixos/nixpkgs?rev=d73ab2f14214a587059fa38cacf82198409e54eb&quot;;
}
</code></pre><h2><a name="etc">Etc</a></h2><p>git is mandatory</p><p>flake.nix is an attribute set</p><p>it is all about outputs</p><p>what are the outputs</p><p>what are the basics commands</p><p>what are the use cases</p><hr/><div class="footer"><p><div class="text-small"> <a href='/en/'>Home</a> • <a href='/en/about/'>About</a> • <a href='/en/quotes/'>Quotes</a> • <a href='/en/reflections/'>Reflections</a> </div></p><p><div class="text-x-small"> Made with ❤️ by Rommel Martínez </div></p><p></div></p></div><script src="/static/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>