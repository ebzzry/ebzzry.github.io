<!DOCTYPE html>
<html lang="en"><head><title>Virtualizing with KVM in Linux</title><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0,user-scalable=yes" name="viewport" /><meta content="noodp,noydir" name="robots" /><meta content="Virtualizing with KVM in Linux" name="description" /><meta content="kvm, qemu, linux" name="keywords" /><meta content="Virtualizing with KVM in Linux" property="og:title" /><meta content="article" property="og:type" /><meta content="https://ebzzry.io/en/kvm/" property="og:url" /><meta content="https://ebzzry.io/static/ico/android-chrome-512x512.png" property="og:image" /><link href="/static/ico/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="/static/ico/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="/static/ico/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/static/ico/manifest.json" rel="manifest" /><link color="#5bbad5" href="/static/ico/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#ffffff" name="theme-color" /><style media="all" type="text/css">html {    color: #333;    font-size: 1em;    font-family: Georgia, Cambria, Palatino, "Palatino Linotype", "Times New Roman", Times, serif;    line-height: 1.45;    text-align: left:    width: 100%;    max-width: 40em;    margin: 0 auto 0 auto;    padding: 0;}body {    border-top: hidden;    border-bottom: hidden;    padding: 0 1.5em 1em 1.5em;    margin: 0;}#content {    -webkit-column-count: 1;    -moz-column-count: 1;    column-count: 1;}code {    font-size: 0.9em;    font-family: "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Lucida Console", "Courier New", Courier, monospace;    color: black;    display: inline-block;    font-weight: bold;}pre code {    font-size: 1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;    font-weight: normal;}kbd {    font-size: 1.1em;    padding: 0.1em 0.6em;    border: 1px solid #ccc;    font-family: monospace;    background-color: #f7f7f7;    color: #333;    -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -moz-border-radius: 3px;    -webkit-border-radius: 3px;    border-radius: 3px;    display: inline-block;    margin: 0 0.1em;    text-shadow: 0 1px 0 #fff;    white-space: nowrap;}h1, h2, h3, h4, h5, h6 {    font-family: Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans", Tahoma, Geneva, Helvetica, Arial, sans-serif;    margin-bottom: 0;}h1 {    font-size: 2.5em;    text-align: center;    border-bottom: 6px solid black;}h2 {    font-size: 2.0em;    text-align: left;    border-bottom: 2px solid black;}h3 {    font-size: 1.6em;    text-align: left;    border-bottom: 1px solid lightgrey;}h4 {    font-size: 1.5em;    text-align: left;}h5 {    font-size: 1.3em;    text-align: left;}ul, ol {    padding-left: 2em;}ul li {    list-style-type: square;}ul li li {    list-style-type: disc;}ul li li li {    list-style-type: circle;}ol li {    list-style-type: decimal;}p, para, b, strong, i, em, emph {    font-size: 1em;}blockquote {    font-size: 1.2em;    font-style: italic;    margin-left: 2em;}b, strong {    font-weight: bold;}i, em, emph {    font-style: italic;}table {    margin: 0.5em;    border-spacing: 0;    border-collapse: collapse;}th, td {    border: 1px solid lightgray;    padding-top: 0;    padding-bottom: 0;    padding-left: 0.45em;    padding-right: 0.45em;}.text-right {    text-align: right;}.text-small {    font-size: small;}.text-x-small {    font-size: x-small;}.banner {    display: block;    width: 100%;    margin-left: auto;    margin-right: auto;}.footer {    text-align: right;    float: right;    max-width: 18em;}.cc {    border-width: 0}.center {    text-align: center;}</style><style media="all" type="text/css">/* Ewan Themes -- based 99.99% from Tomorrow Night Theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Original theme - https://github.com/chriskempson/tomorrow-theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Tomorrow Comment */.hljs-comment {  color: #969896;}/* Tomorrow Red */.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo {  color: #cc6666;}/* Tomorrow Orange */.hljs-number,.hljs-preprocessor,.hljs-pragma,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant {  color: #de935f;}/* Tomorrow Yellow */.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute {  color: #f0c674;}/* Tomorrow Green */.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.hljs-name,.ruby .hljs-symbol,.xml .hljs-cdata {  color: #b5bd68;}/* Tomorrow Aqua */.hljs-title,.css .hljs-hexcolor {  color: #8abeb7;}/* Tomorrow Blue */.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title {  color: #81a2be;}/* Tomorrow Purple */.hljs-keyword,.javascript .hljs-function {  color: #b294bb;}.hljs {  display: block;  overflow-x: auto;  background: #1d1f21;  color: #c5c8c6;  padding: 0.5em;  -webkit-text-size-adjust: none;}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata {  opacity: 0.5;}pre code {    font-size: 1.1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;}</style></head><body><div id="content"><h1>Virtualizing with KVM in Linux</h1><p><div class="center">June 15, 2015</div> <div class="center">Updated: November 7, 2017</div></p><blockquote><p>If you do what youâ€™ve always done, youâ€™ll get what youâ€™ve always gotten.<br> â€•Anthony Robbins </p></blockquote><p>Most of you are familiar with <a href='https://en.wikipedia.org/wiki/Full_virtualization'>full virtualization</a> solutions like VMware Workstation, Oracle VirtualBox, and Parallels. In this post, Iâ€™ll re-introduce you to another, arguably faster, way of doing things.</p><p>The <code>$</code> symbol will be used to indicate the shell prompt for a regular user, while the <code>#</code> symbol will denote the shell for the root user. There are cases when the <a href='https://en.wikipedia.org/wiki/User_identifier#Effective_user_ID'>EUID</a> of a command will be zero (0) due to the use of sudo.</p><h2>Table of contents</h2><ul><li><a href='#setup'>Setup</a><ul><li><a href='#hardware'>Hardware</a></li><li><a href='#software'>Software</a></li></ul></li><li><a href='#configuration'>Configuration</a><ul><li><a href='#images'>Images</a></li><li><a href='#networking'>Networking</a></li></ul></li><li><a href='#execution'>Execution</a><ul><li><a href='#loadimage'>Load the image</a></li><li><a href='#display'>Connect to the SPICE display</a></li><li><a href='#guestnetworking'>Configure guest networking</a></li></ul></li><li><a href='#closingcurtains'>Closing the curtains</a><ul><li><a href='#restorenetworking'>Restore networking</a></li></ul></li><li><a href='#all'>Putting it all</a></li><li><a href='#closing'>Closing remarks</a></li></ul><h2><a name="setup"></a> Setup</h2><h3><a name="hardware"></a> Hardware</h3><p>One of the first things that you need to do is to enable <a href='https://en.wikipedia.org/wiki/Hardware-assisted_virtualization'>Hardware-assisted virtualization</a>, also called accelerated virtualization, in your hardware. If your CPU was made before 2006, chances are, this feature wonâ€™t be present on your chip. Also, take note that this step is not compulsory to make use of the virtualization solution described in this post, but it will <i>significantly</i> speed things up.</p><p>To enable accelerated virtualization, go into your BIOS/UEFI settings, and look for the knob that enables this feature. The name into which it goes is different from manufacturer to manufacturer. Save the settings, then boot your system. You can verify on the command line if your system indeed recognizes it.</p><pre><code>$ egrep '&#40;vmx|svm&#41;' /proc/cpuinfo</code></pre><p>If it returns some text, then youâ€™re good.</p><h3><a name="software"></a> Software</h3><p>Next, you need to install the essential applications.</p><p>Nix:</p><pre><code>$ nix-env -i qemu vde2 spice&#95;gtk</code></pre><p>APT:</p><pre><code>$ sudo apt-get install qemu-kvm vde2 spice-client-gtk</code></pre><p>This will install the <a href='http://wiki.qemu-project.org/Main_Page'>QEMU</a> /kee-MOO/ hypervisor, <a href='http://vde.sourceforge.net/'>VDE</a> tools, and <a href='http://www.spice-space.org/'>SPICE</a> support. QEMU, at least during its early days had the <i>meh</i> impressionâ€”it is OK, but not stellar. Since version 0.10.1, QEMU started supporting <a href='http://www.linux-kvm.org/'>KVM</a>, a virtualization subsystem for Linux, that provides near-native virtualization performance using hardware-assisted virtualization. It even rivals the performance of the virtualization solutions mentioned above.</p><p>Other suites offer the option of connecting to the guest machineâ€™s display via VNC. The problem is that, itâ€™s slow and clunky. The response time is just horrible. Using the <a href='http://www.spice-space.org/'>SPICE</a> protocol, not only does it makes things faster, but it makes other things possible. Take note that SPICE is not a replacement for <a href='https://en.wikipedia.org/wiki/Virtual_Network_Computing'>VNC</a>, but rather, it a different way of meeting your goals.</p><h2><a name="configuration"></a> Configuration</h2><h3><a name="images"></a> Images</h3><p>QEMU supports an array of image types, however the <a href='https://en.wikipedia.org/wiki/Qcow'>QCOW2</a> format is the most flexible, and feature-rich, for QEMU use.</p><p>If you have an existing VirtualBox file (VDI), you can convert it to QCOW2 with:</p><pre><code>$ qemu-img convert -f vdi -O qcow2 vm.vdi vm.qcow2</code></pre><p>However, if you donâ€™t have an image, yet, you can create one with:</p><pre><code>$ qemu-img create -f qcow2 vm.qcow2 20G</code></pre><p>The last step creates a 20GB image, that is named <code>vm.qcow2</code>. Take note that the extension name doesnâ€™t really matterâ€”you can name your image as <code>index.html</code>, but that wouldnâ€™t make a lot of sense, right? ðŸ˜„</p><h3><a name="kvmgroup"></a> KVM group</h3><p>The commands below require that a group named <code>kvm</code> exists and that you are a member of that group. To take those into effect, run:</p><pre><code>$ sudo groupadd kvm
$ sudo usermod -G $&#40;groups | sed 's/ /,/g'&#41;,kvm $USER
$ newgrp kvm</code></pre><p>The last command enrolls you to the kvm group without logging out of your session.</p><h3><a name="networking"></a> Networking</h3><p>QEMU supports <a href='http://wiki.qemu-project.org/Documentation/Networking'>many ways</a> of setting up networking for its guests, but for this post weâ€™ll use VDE.</p><p>You need to run several commands to prep the networking environment. Ideally, youâ€™d want to save these in a shell function, or a shell script:</p><pre><code class="bash">$ sudo vde&#95;switch -tap tap0 -mod 660 -group kvm -daemon
$ sudo ip addr add 10.0.2.1/24 dev tap0
$ sudo ip link set dev tap0 up
$ sudo sysctl -w net.ipv4.ip&#95;forward=1
$ sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
</code></pre><p>The above commands will:</p><ol><li>Create a VDE device</li><li>Configure the TCP/IP options for that device</li><li>Enable the VDE device</li><li>Enable packet forwarding on the host OS</li><li>Setup the routing configuration</li></ol><h2><a name="execution"></a> Execution</h2><h3><a name="loadimage"></a> Load the image</h3><p>You now need to invoke <code>qemu-kvm</code>, the command that will launch everything up. The name of the command may differ with the one installed on your system.</p><p>If youâ€™re installing an OS from a bootable image, usually an ISO file, run:</p><pre><code class="bash">$ sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio \
-net vde -soundhw all -vga qxl \
-spice port=9999,addr=127.0.0.1,password=supersecretkey \
-boot once=d -cdrom installer.iso \
vm.qcow2
</code></pre><p>On subsequent uses:</p><pre><code class="bash">$ sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio \
-net vde -soundhw all -vga qxl \
-spice port=9999,addr=127.0.0.1,password=supersecretkey \
vm.qcow2
</code></pre><p>Letâ€™s break that down:</p><pre><code>-cpu host</code></pre><p>Use the KVM processor with all the supported features</p><pre><code>-m 2G</code></pre><p>Allocate 2GiB of host memory for the guest. Adjust as necessary.</p><pre><code>-net nic,model=virtio -net vde</code></pre><p>Create a virtual NIC, and enable VDE networking</p><pre><code>-soundhw all</code></pre><p>Enable all audio drivers</p><pre><code>-vga qxl</code></pre><p>Specify the video adapter to emulate. Use QXL when using SPICE</p><pre><code>-spice addr=127.0.0.1,port=9999,password=supersecretkey</code></pre><p>Specify the options for SPICE, separated by commas. <i>addr</i> and <i>port</i> are the IP address and TCP port that SPICE will listen on. Ideally, access to that port must be properly configured, and secured. <i>password</i> is key that will be used by the SPICE client, <i>spicec</i>, to connect to the guest display later.</p><pre><code>-boot once=d -cdrom installer.iso</code></pre><p>Boot initially from <code>installer.iso</code>, then on subsequent boots, boot in the normal order.</p><p>Running the <i>qemu-kvm</i> command above will load the image, but you wonâ€™t be able to view the display, yet.</p><h3><a name="display"></a> Connect to the SPICE display</h3><p>To be able to use the guest machineâ€™s display, you need to connect to the SPICE server, using the SPICE client <code>spicy</code>:</p><pre><code>$ spicy -h 127.0.0.1 -p 5901 -w supersecretkey</code></pre><p>Take note that closing the spicy window will not kill the QEMU session. If the guest OS captures the mouse input, press <kbd>Shift+F12</kbd>, to get out of it.</p><h3><a name="guestnetworking"></a> Configure guest networking</h3><p>Next, you need to properly configure the network configuration of the guest OS so that it can connect to the rest of the local network, and to the internet if the host machine has access to it.</p><p>IP address:</p><pre><code>10.0.2.2</code></pre><p>Default gateway:</p><pre><code>10.0.2.1</code></pre><p>DNS servers:</p><pre><code>8.8.8.8
8.8.4.4</code></pre><h2><a name="closingcurtains"></a> Closing the curtains</h2><h3><a name="restorenetworking"></a> Restore networking</h3><p>If you want to explicitly revert the network configuration, do the following.</p><pre><code class="bash">$ sudo iptables -t nat -D POSTROUTING -s 10.0.2.0/24 \
-j MASQUERADE
$ sudo sysctl -w net.ipv4.ip&#95;forward=0
$ sudo ip link set dev tap0 down
$ sudo ip link delete tap0
$ sudo pkill -9 vde&#95;switch
$ sudo rm -f /run/vde.ctl/ctl
</code></pre><p>The above commands will:</p><ol><li>Revert the routing configuration</li><li>Disable packet forwarding</li><li>Disable the VDE device</li><li>Delete the VDE device</li><li>Kill the VDE process</li><li>Remove control files</li></ol><h2><a name="all"></a> Putting it all</h2><p>Here are all the commands from above, compiled into functions, so that they can be ran from the command line:</p><pre><code>function kvm-net &#40;&#41; {
  case $1 in
    up&#41;
      sudo vde&#95;switch -tap tap0 -mod 660 -group kvm -daemon
      sudo ip addr add 10.0.2.1/24 dev tap0
      sudo ip link set dev tap0 up
      sudo sysctl -w net.ipv4.ip&#95;forward=1
      sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
      ;;
    down&#41;
      sudo iptables -t nat -D POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
      sudo sysctl -w net.ipv4.ip&#95;forward=0
      sudo ip link set dev tap0 down
      sudo ip link delete tap0
      sudo pkill -9 vde&#95;switch
      sudo rm -f /run/vde.ctl/ctl
      ;;
  esac
}

function kvm-boot &#40;&#41; {
    sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio -net vde \
    -soundhw all -vga qxl \
    -spice port=6900,addr=127.0.0.1,disable-ticketing \
    $@
}

function kvm-iso &#40;&#41; {
    kvm-boot -boot once=d -cdrom $1 ${argv&#91;2,-1&#93;}
}

function kvm-display &#40;&#41; {
    spicy -p 6900 -h 127.0.0.1
}
</code></pre><p>Iâ€™ll walk you through.</p><p>Initially, setup the netoworking:</p><pre><code>$ kvm-net up</code></pre><p>Then, load the image:</p><pre><code>$ kvm-boot vm.qcow2</code></pre><p>Finally, connect to the display:</p><pre><code>$ kvm-display</code></pre><p>When youâ€™re done with the VM, close the Spice display then shutdown the KVM networking:</p><pre><code>$ kvm-net down</code></pre><h2><a name="closing"></a> Closing remarks</h2><p>QEMU supports a myriad of cool options that weâ€™ve not even discussed here, including saving and loading states (snapshots), creating screen and audio grabs, and a whole lot more. To learn more about them, click <a href='http://wiki.qemu-project.org/Main_Page'>here</a>.</p><p>QEMU with KVM is a powerful, fast, and flexible solution for doing <a href='https://en.wikipedia.org/wiki/Full_virtualization'>Full Virtualization</a>. At least in my case, it out-performs the well-known options in the market. If you want to contribute to this project, head over to their <a href='https://github.com/qemu/qemu'>GitHub page</a>.</p><p>I hope this post helped you, in one way or another, learn more about QEMU and KVM and what it has to offer.</p><hr/><div class="footer"><p><div class="text-small"> <a href='/en'>Home</a>Â Â·Â <a href='/en/about'>About</a>Â Â <a href='/en/quotes'>Quotes</a>Â Â <a href='/en/reflections'>Reflections</a>Â Â <a href='https://github.com/ebzzry/ebzzry.github.io'>Source</a> </div> <div class="text-x-small"> Created with <a href='https://github.com/ebzzry/emem'>emem</a> </div></p><p><div class="text-x-small"> <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.en"><img alt="Creative Commons Attribution-ShareAlike 4.0 International License" class="cc" src="/bildoj/cc4-sa-88x31.png" /></a><br> Licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.en">CC BY-SA 4.0 License.</a><br> </div></p><p></div></p></div><script src="/static/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-93746003-1', 'auto');ga('send', 'pageview');</script></body></html>