<!DOCTYPE html>
<html lang="en"><head><title>Zsh Tips 3: Chroot Helpers</title><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0,user-scalable=yes" name="viewport" /><meta content="noodp,noydir" name="robots" /><meta content="Zsh Tips 3: Chroot Helpers" name="description" /><meta content="zsh, tips, advice, shell, linux, configuration, setup, settings, chroot" name="keywords" /><meta content="Zsh Tips 3: Chroot Helpers" property="og:title" /><meta content="article" property="og:type" /><meta content="https://ebzzry.io/en/zsh-tips-3/" property="og:url" /><meta content="https://ebzzry.io/static/ico/android-chrome-512x512.png" property="og:image" /><link href="/static/ico/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="/static/ico/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="/static/ico/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/static/ico/manifest.json" rel="manifest" /><link color="#5bbad5" href="/static/ico/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#ffffff" name="theme-color" /><style media="all" type="text/css">html {    color: #333;    font-size: 1em;    font-family: Georgia, Cambria, Palatino, "Palatino Linotype", "Times New Roman", Times, serif;    line-height: 1.45;    text-align: left:    width: 100%;    max-width: 40em;    margin: 0 auto 0 auto;    padding: 0;}body {    border-top: hidden;    border-bottom: hidden;    padding: 0 1.5em 1em 1.5em;    margin: 0;}#content {    -webkit-column-count: 1;    -moz-column-count: 1;    column-count: 1;}code {    font-size: 0.9em;    font-family: "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Lucida Console", "Courier New", Courier, monospace;    color: black;    display: inline-block;    font-weight: bold;}pre code {    font-size: 1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;    font-weight: normal;}kbd {    font-size: 1.1em;    padding: 0.1em 0.6em;    border: 1px solid #ccc;    font-family: monospace;    background-color: #f7f7f7;    color: #333;    -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -moz-border-radius: 3px;    -webkit-border-radius: 3px;    border-radius: 3px;    display: inline-block;    margin: 0 0.1em;    text-shadow: 0 1px 0 #fff;    white-space: nowrap;}h1, h2, h3, h4, h5, h6 {    font-family: Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans", Tahoma, Geneva, Helvetica, Arial, sans-serif;    margin-bottom: 0;}h1 {    font-size: 2.5em;    text-align: center;    border-bottom: 6px solid black;}h2 {    font-size: 2.0em;    text-align: left;    border-bottom: 2px solid black;}h3 {    font-size: 1.6em;    text-align: left;    border-bottom: 1px solid lightgrey;}h4 {    font-size: 1.5em;    text-align: left;}h5 {    font-size: 1.3em;    text-align: left;}ul, ol {    padding-left: 2em;}ul li {    list-style-type: square;}ul li li {    list-style-type: disc;}ul li li li {    list-style-type: circle;}ol li {    list-style-type: decimal;}p, para, b, strong, i, em, emph {    font-size: 1em;}blockquote {    font-size: 1.2em;    font-style: italic;    margin-left: 2em;}b, strong {    font-weight: bold;}i, em, emph {    font-style: italic;}table {    margin: 0.5em;    border-spacing: 0;    border-collapse: collapse;}th, td {    border: 1px solid lightgray;    padding-top: 0;    padding-bottom: 0;    padding-left: 0.45em;    padding-right: 0.45em;}.text-right {    text-align: right;}.text-small {    font-size: small;}.text-x-small {    font-size: x-small;}.banner {    display: block;    width: 100%;    margin-left: auto;    margin-right: auto;}.footer {    text-align: right;    float: right;    max-width: 18em;}.cc {    border-width: 0}.center {    text-align: center;}</style><style media="all" type="text/css">/* Ewan Themes -- based 99.99% from Tomorrow Night Theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Original theme - https://github.com/chriskempson/tomorrow-theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Tomorrow Comment */.hljs-comment {  color: #969896;}/* Tomorrow Red */.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo {  color: #cc6666;}/* Tomorrow Orange */.hljs-number,.hljs-preprocessor,.hljs-pragma,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant {  color: #de935f;}/* Tomorrow Yellow */.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute {  color: #f0c674;}/* Tomorrow Green */.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.hljs-name,.ruby .hljs-symbol,.xml .hljs-cdata {  color: #b5bd68;}/* Tomorrow Aqua */.hljs-title,.css .hljs-hexcolor {  color: #8abeb7;}/* Tomorrow Blue */.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title {  color: #81a2be;}/* Tomorrow Purple */.hljs-keyword,.javascript .hljs-function {  color: #b294bb;}.hljs {  display: block;  overflow-x: auto;  background: #1d1f21;  color: #c5c8c6;  padding: 0.5em;  -webkit-text-size-adjust: none;}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata {  opacity: 0.5;}pre code {    font-size: 1.1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;}</style></head><body><div id="content"><h1>Zsh Tips 3: Chroot Helpers</h1><p><div class="center"><a href='/eo/zisxkonsiletoj-3-a'>Esperanto</a> · <a href='#'>English</a></div> <div class="center">October 20, 2017</div> <div class="center">Last updated: September 23, 2018</div></p><blockquote><p>We laugh at that which we cannot bear to face.<br> ―Aristotle </p></blockquote><p>Technologies such as Docker, QEMU, and VirtualBox are great tools when one wants to run processes separate from the host system. These techniques provide us with completely isolated environments that makes it easy to test for the reproducibility of code. However, there are times when these solutions are too heavy, and we need something lighter. Enter chroot. Unlike its heavier friends, chroot sits somewhere closer to the filesystem, wherein it can easily access the resources of the environment invoking it.</p><p>In this article, I’ll talk about how to setup a chroot environment on Linux with Zsh. Technically, this is a mixture of shell discussion and system administration, but since I’m using features that are exclusive to Zsh—or otherwise difficult in other shells—I went with that title.</p><h2><a name="toc">Table of contents</a></h2><ul><li><a href='#overview'>Overview</a></li><li><a href='#prerequisites'>Prerequisites</a></li><li><a href='#installation'>Installation</a></li><li><a href='#configuration'>Configuration</a></li><li><a href='#commands'>Define the commands</a></li><li><a href='#trying'>Trying it out</a></li><li><a href='#closing'>Closing remarks</a></li></ul><h2><a name="overview">Overview</a></h2><p>Every now and then, I need to quickly run commands for other systems, for example, Ubuntu, so that I can test my software, with persistent storage mechanisms and fast access to system binaries. Other options are too resource intensive and I just want it done fast, and now.</p><h2><a name="prerequisites">Prerequisites</a></h2><p>To create the actual separate environment, we need a way to fetch and install it to our disk. For that, we need to have debootstrap.</p><p>On Nixpkgs systems:</p><pre><code>% nix-env -i debootstrap</code></pre><p>On APT systems:</p><pre><code>% sudo apt-get install -y debootstrap</code></pre><p>To make things seamless, we will use the same username and UID, of the host system:</p><pre><code>% id -un; id -u</code></pre><h2><a name="installation">Installation</a></h2><p>First, we create the target directory:</p><pre><code>% sudo mkdir -p /home/chrt/ubuntu</code></pre><p>Next, we tell debootstrap to install a specific Ubuntu distribution:</p><pre><code>% sudo debootstrap xenial /home/chrt/ubuntu http://archive.ubuntu.com/ubuntu</code></pre><p>When it is completed, we need to create bind mounts from our system to the target system:</p><pre><code>% sudo mount --bind /proc /home/chrt/ubuntu/proc
% sudo mount --bind /sys /home/chrt/ubuntu/sys
% sudo mount --bind /tmp /home/chrt/ubuntu/tmp
% sudo mount --bind /home /home/chrt/ubuntu/home
% sudo mount --bind /dev /home/chrt/ubuntu/dev
% sudo mount --bind /dev/pts /home/chrt/ubuntu/dev/pts</code></pre><h2><a name="configuration">Configuration</a></h2><p>For the chroot to properly work, we need to go inside it first and make changes:</p><pre><code>% sudo chroot /home/chrt/ubuntu</code></pre><p>At this point, you will be logged in as root, using Bash. Let’s install some tools:</p><pre><code># apt-get install -y zsh sudo</code></pre><p>Then, let’s create your chroot-specific account. Let’s make it uniform with the one that you are using now. Let’s presume that your username is <code>vakelo</code> and the UID is <code>1000</code>.</p><pre><code># useradd -u 1000 -m vakelo
# passwd vakelo</code></pre><p>Then, let’s make <code>vakelo</code> part of the <code>sudo</code> group:</p><pre><code># usermod -aG sudo vakelo</code></pre><p>Then, let’s tell sudo not to prompt you for your user password. For that, we need to use <code>visudo</code></p><pre><code># visudo</code></pre><p>Visudo is a nice wrapper for editing the sudo configuration file, because in the event that we make mistakes, it will inform us about it, and will not process your changes, prompting you to correct it. For our case, we need to instruct sudo that we don’t want to be asked about our password. Change the following line:</p><pre><code>%sudo   ALL=&#40;ALL:ALL&#41; ALL</code></pre><p>to</p><pre><code>%sudo   ALL=&#40;ALL:ALL&#41; NOPASSWD: ALL</code></pre><p>Exit the editor. After that, exit the chroot, too:</p><pre><code># exit</code></pre><h2><a name="commands">Define the commands</a></h2><p>Now that we’re back on the host, we need to define the commands that you will actually use to interact with the chroot. Open the file <code>&#126;/.zshenv</code> with your editor, then put in the following:</p><pre><code class="bash">CHROOT=/home/chrt/ubuntu

function crmount &#40;&#41; {
  for i &#40;proc sys tmp home dev&#41; {
    if &#91;&#91; ! -d $1/$i &#93;&#93;; then
      mkdir -p $1/$i
    fi

    sudo mount --bind /$i $1/$i
  }

  sudo mount --bind /dev/pts $1/dev/pts
}

function crumount &#40;&#41; {
  for i &#40;proc sys tmp home dev&#41; {
    sudo umount -fl $1/$i
  }
}

function crm &#40;&#41; {
  crmount $1
}

function cru &#40;&#41; {
  crumount $CHROOT 2&gt; /dev/null
}

function crch &#40;&#41; {
  sudo chroot $@
}

function crr &#40;&#41; {
  if ! mount | grep -q $1; then
    crm $1
  fi

  crch $1 ${argv&#91;2,-1&#93;}
}

function crs &#40;&#41; {
  crr $1 /usr/bin/sudo -i -u $USER ${argv&#91;2,-1&#93;}
}

function cre &#40;&#41; {
  if &#91;&#91; -e $CHROOT &#93;&#93;; then
      crs $CHROOT $@
  fi
}

function cr &#40;&#41; {
  if &#40;&#40; ! $#@ &#41;&#41;; then
      cr ${${SHELL:t}:-sh}
  else
    cre zsh -c &quot;cd \&quot;$PWD\&quot;; exec $&#42;&quot;
  fi
}
</code></pre><p>Save your changes, then exit the editor. After that, start a new shell so that the new commands will be read from the startup file.</p><h2><a name="trying">Trying it out</a></h2><p>Let’s get the date from the chroot:</p><pre><code>% cr date</code></pre><p>Let’s also look at the uname output:</p><pre><code>% cr uname -a</code></pre><p>You may also run <code>cr</code> without arguments, to enter a shell:</p><pre><code>% cr</code></pre><p>Inside this shell, the environment has access to the environment outside, including your home directory. This allows us to install applications that can make use the data in our host environment.</p><p>If you want to explicitly turn the chroot environment off, run:</p><pre><code>% cru</code></pre><h2><a name="closing">Closing remarks</a></h2><p>Having an environment to test software and run programs exclusive to that platform, in a lighter environment, certainly is a helpful addition.</p><hr/><div class="footer"><p><div class="text-small"> <a href='/en'>Home</a> · <a href='/en/about'>About</a> · <a href='/en/quotes'>Quotes</a> · <a href='/en/reflections'>Reflections</a> · <a href='https://github.com/ebzzry/ebzzry.github.io'>Source</a> </div> <div class="text-x-small"> Created with <a href='https://github.com/ebzzry/emem'>emem</a> <div></p><p><div class="text-x-small"> <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.en"><img alt="CC0 1.0 Universal (CC0 1.0) Public Domain Dedication" class="cc" src="/bil/cc0-88x31.png" /></a><br> This work is in the <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.en">public domain.</a><br> </div></p><p></div></p></div><script src="/static/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-93746003-1', 'auto');ga('send', 'pageview');</script></body></html>