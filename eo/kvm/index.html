<!DOCTYPE html>
<html lang="eo"><head><title>Virtualigado en Linukso per KVM</title><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0,user-scalable=yes" name="viewport" /><meta content="noodp,noydir" name="robots" /><link rel='apple-touch-icon' sizes='180x180' href='/images/ico/apple-touch-icon.png'><link rel='icon' type='image/png' sizes='32x32' href='/images/ico/favicon-32x32.png'><link rel='icon' type='image/png' sizes='16x16' href='/images/ico/favicon-16x16.png'><link rel='manifest' href='/images/ico/site.webmanifest'><link rel='mask-icon' href='/images/ico/safari-pinned-tab.svg' color='#5bbad5'><link rel='shortcut icon' href='/images/ico/favicon.ico'> <meta name='msapplication-TileColor' content='#da532c'> <meta name='msapplication-config' content='/images/ico/browserconfig.xml'> <meta name='theme-color' content='#ffffff'><meta content="" name="description" /><meta content="" name="keywords" /><meta content="" property="og:title" /><meta content="article" property="og:type" /><meta content="https://ebzzry.com/eo/kvm/" property="og:url" /><meta content="" property="og:image" /><style media="all" type="text/css">html {    color: #333;    font-size: 1em;    font-family: Georgia, Cambria, Palatino, "Palatino Linotype", "Times New Roman", Times, serif;    line-height: 1.45;    text-align: left:    width: 100%;    max-width: 40em;    margin: 0 auto 0 auto;    padding: 0;}body {    border-top: hidden;    border-bottom: hidden;    padding: 0 1.5em 1em 1.5em;    margin: 0;}#content {    -webkit-column-count: 1;    -moz-column-count: 1;    column-count: 1;}code {    font-size: 0.9em;    font-family: "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Lucida Console", "Courier New", Courier, monospace;    color: black;    display: inline-block;}pre code {    font-size: 1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;    font-weight: normal;}kbd {    font-size: 1.1em;    padding: 0.1em 0.6em;    border: 1px solid #ccc;    font-family: monospace;    background-color: #f7f7f7;    color: #333;    -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -moz-border-radius: 3px;    -webkit-border-radius: 3px;    border-radius: 3px;    display: inline-block;    margin: 0 0.1em;    text-shadow: 0 1px 0 #fff;    white-space: nowrap;}h1, h2, h3, h4, h5, h6 {    font-family: Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans", Tahoma, Geneva, Helvetica, Arial, sans-serif;    margin-bottom: 0;}h1 {    font-size: 2.5em;    text-align: center;    border-bottom: 6px solid black;}h2 {    font-size: 2.0em;    text-align: left;    border-bottom: 2px solid black;}h3 {    font-size: 1.6em;    text-align: left;    border-bottom: 1px solid lightgrey;}h4 {    font-size: 1.5em;    text-align: left;}h5 {    font-size: 1.3em;    text-align: left;}ul, ol {    padding-left: 2em;}ul li {    list-style-type: square;}ul li li {    list-style-type: disc;}ul li li li {    list-style-type: circle;}ol li {    list-style-type: decimal;}p, para, b, strong, i, em, emph {    font-size: 1em;}blockquote {    font-size: 1.2em;    font-style: italic;    margin-left: 2em;}b, strong {    font-weight: bold;}i, em, emph {    font-style: italic;}table {    margin: 0.5em;    border-spacing: 0;    border-collapse: collapse;}th, td {    border: 1px solid lightgray;    padding-top: 0;    padding-bottom: 0;    padding-left: 0.45em;    padding-right: 0.45em;}.text-right {    text-align: right;}.text-small {    font-size: small;}.text-x-small {    font-size: x-small;}.banner {    display: block;    width: 100%;    margin-left: auto;    margin-right: auto;}.footer {    text-align: right;    float: right;    max-width: 18em;}.cc {    border-width: 0}.center {    text-align: center;}</style><style media="all" type="text/css">/* Ewan Themes -- based 99.99% from Tomorrow Night Theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Original theme - https://github.com/chriskempson/tomorrow-theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Tomorrow Comment */.hljs-comment {  color: #969896;}/* Tomorrow Red */.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo {  color: #cc6666;}/* Tomorrow Orange */.hljs-number,.hljs-preprocessor,.hljs-pragma,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant {  color: #de935f;}/* Tomorrow Yellow */.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute {  color: #f0c674;}/* Tomorrow Green */.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.hljs-name,.ruby .hljs-symbol,.xml .hljs-cdata {  color: #b5bd68;}/* Tomorrow Aqua */.hljs-title,.css .hljs-hexcolor {  color: #8abeb7;}/* Tomorrow Blue */.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title {  color: #81a2be;}/* Tomorrow Purple */.hljs-keyword,.javascript .hljs-function {  color: #b294bb;}.hljs {  display: block;  overflow-x: auto;  background: #1d1f21;  color: #c5c8c6;  padding: 0.5em;  -webkit-text-size-adjust: none;}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata {  opacity: 0.5;}pre code {    font-size: 1.1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;}</style></head><body><div id="content"><h1>Virtualigado en Linukso per KVM</h1><p><div class="center"><a href='/en/kvm/'>English</a> ∅ Esperanto</div> <div class="center">dim sep 9 12:14:56 2018 +0800</div></p><blockquote><p>Se oni faras tion, kion oni ĉiam faras; oni akiros tion , kion oni ĉiam akiras.<br> —Anthony ROBBINS </p></blockquote><p><img src="/images/site/pierre-chatel-innocenti-N6Hx4HT4mHg-unsplash-1008x250.jpg" style="display: block; width: 100%; margin-left: auto; margin-right: auto;" alt="pierre-chatel-innocenti-N6Hx4HT4mHg-unsplash" title="pierre-chatel-innocenti-N6Hx4HT4mHg-unsplash"/></p><h2><a name="et">Enhavotabelo</a></h2><ul><li><a href='#enkonduko'>Enkonduko</a></li><li><a href='#agordajxo'>Agordaĵo</a><ul><li><a href='#aparataro'>Aparataro</a></li><li><a href='#programaro'>Programaro</a></li></ul></li><li><a href='#agordo'>Agordo</a><ul><li><a href='#bildoj'>Bildoj</a></li><li><a href='#grupo'>KVM-grupo</a></li><li><a href='#retkonektado'>Retkonektado</a></li></ul></li><li><a href='#rulo'>Rulo</a><ul><li><a href='#sxargu'>La bildon ŝargi</a></li><li><a href='#ekrano'>Konekti al la SPICE-ekrano</a></li><li><a href='#gastareto'>La gastan reton agordi</a></li></ul></li><li><a href='#kurtenoj'>La kurtenojn fermi</a><ul><li><a href='#restauxri'>La retkonektadon restaŭri</a></li></ul></li><li><a href='#cxio'>Ĉion kolekti</a></li><li><a href='#finrimarkoj'>Finrimarkoj</a></li></ul><h2><a name="enkonduko">Enkonduko</a></h2><p>Plejmulto da ni konas la <a href='https://en.wikipedia.org/wiki/Full_virtualization'>tutvirtualigadajn</a> solvojn kiel <em>VMware Workstation</em>, <em>Oracle VirtualBox</em>, kaj <em>Parallels</em>. En ĉi tiu afiŝo, mi reenkondukos al oni alian metodon por aferojn fari.</p><p>La dolarsigno ($) uziĝos por indiki la ŝelan inviton de normuzanto, dum la kradsigno (#) uziĝos por indiki la ŝelan inviton de la ĉefuzanto. Estas fojoj kiam la <a href='https://en.wikipedia.org/wiki/User_identifier#Effective_user_ID'>EUID</a> de komando estos nulo (0) pro la uzado de <em>sudo</em>.</p><h2><a name="agordajxo">Agordaĵo</a></h2><h3><a name="aparataro">Aparataro</a></h3><p>Unu el la plej unuaj aferoj kiujn oni devas fari estas ŝalti la [aparataro-asistitan virtualigadon](https://en.wikipedia.org/wiki/Hardware-assisted_virtualization), ankaŭ nomiĝas plirapigita virtualigado, ĉe la aparataro. Se la ĉefprocezilo estis kreita antaŭ 2006, plej verŝajne, ĉi tiu kapablo ne ĉeestas en la ico. Ankaŭ, memoru, ke ĉi tiu paŝo ne estas devigita por uzi iujn ajn kapablojn en ĉi tiu afiŝo, tamen ĝi <i>atentinde</i>plirapidigos la aferojn.</p><p>Por ŝalti plirapigitan virtualigadon, iru al la BIOS/UEFI-agordoj, kaj trovu la tenilon por ĉi tiun kapablon. La nomo de ĉi tiu kapablo malsamas inter fabrikanto al fabrikanto. Konservu la agordon, tiam la sistemon reŝargu. Tiam, oni nun povas verigi la kapablon komandlinie.</p><pre><code>$ egrep '&#40;vmx|svm&#41;' /proc/cpuinfo</code></pre><p>Se ĝi revenigas kelkajn tekstojn, oni pretas.</p><h3><a name="programaro">Programaro</a></h3><p>Sekve, oni devas instali la havendajn apojn:</p><p>Nix:</p><pre><code>$ nix-env -i qemu vde2 spice&#95;gtk</code></pre><p>APT:</p><pre><code>$ sudo apt-get install -y qemu-kvm vde2 spice-client-gtk</code></pre><p>Ĉi tiu instalas la <a href='http://wiki.qemu-project.org/Main_Page'>QEMU</a>-hiperregilon, la <a href='http://vde.sourceforge.net/'>VDE</a>-ilojn, kaj <a href='http://www.spice-space.org/'>SPICE</a>-subtenon. QEMU, almenaŭ dum siaj fruaj tagoj ne estis impresa—ĝi estis bona, sed ne bonegas. Ekde versio 0.10.1, QEMU komencis subteni <a href='http://www.linux-kvm.org/'>KVM</a>-kapablojn—virtualigada subsistemo por linukso—kiu preskaŭ disponigas denaskan virtualigadon per aparataro-asistita virtualigado. Ĝi eĉ konkurigas la ekonomiojn de la aliaj virtualigadaj sistemoj menciitaj ĉi-supre.</p><p>Aliaj aplikaĵaroj ofertas la opcion de konekti al la gasta maŝina ekrano per <a href='https://en.wikipedia.org/wiki/Virtual_Network_Computing'>VNC</a> . Bedaŭrinde, ĝi malrapidas kaj malviglas. La respondtempo teruras. Uzi la <a href='http://www.spice-space.org/'>SPICE</a>-protokolon, ne nur plirapidigas la aferojn, ĝi ankaŭ ebligas aliajn aferojn. Memoru, ke SPICE ne estas anstataŭaĵo por VNC, anstataŭe, ĝi estas alia maniero por renkonti la celojn.</p><h2><a name="agordo">Agordo</a></h2><h3><a name="bildoj">Bildoj</a></h3><p>QEMU subtenas tabelon de bildaj tipoj, tamen la <a href='https://en.wikipedia.org/wiki/Qcow'>QCOW2</a>-formato estas la plej fleksebla, kaj kapable riĉas, por la uzado de QEMU.</p><p>Oni havas se ekzistantan VirtualBox-dosieron (VDI), oni povas konverti ĝin al QCOW2 per:</p><pre><code>$ qemu-img convert -f vdi -O qcow2 vm.vdi vm.qcow2</code></pre><p>Tamen, se oni ne jam havas bildon, oni povas krei ĝin per:</p><pre><code>$ qemu-img create -f qcow2 vm.qcow2 20G</code></pre><p>La lasta paŝo kreas 20GiB-bildon, kiu nomiĝas <code>vm.qcow2</code>. Memoru, ke la dosiersufikso ne fakte gravas—oni povas nomigi la bildon kiel <code>index.html</code>, tamen tio ne estus sencema, ĉu ne? 😄</p><h3><a name="grupo">KVM-grupo</a></h3><p>La komandoj ĉi-sube postulas, ke grupo nomiĝas <code>kvm</code> devas ekzisti kaj oni estas ano de tiu grupo. Por efektivigi tion, rulu la jenajn komandojn:</p><pre><code>$ sudo groupadd kvm
$ sudo usermod -G $&#40;groups | sed 's/ /,/g'&#41;,kvm $USER
$ newgrp kvm</code></pre><p>La lasta komando varbas onin al la grupo <code>KVM </code> grupo senelsalutante el la seanco.</p><h3><a name="retkonektado">Retkonektado</a></h3><p>QEMU subtenas <a href='http://wiki.qemu-project.org/Documentation/Networking'>multajn manierojn</a> por agordi retkonektadon por siaj gastoj, tamen por ĉi tiu afiŝo ni uzos nur VDE.</p><p>Oni devas ruli kelkajn komandojn por pretigi la retan medion. Ideale, oni volas konservi la komandojn en ŝela funkcio aŭ skripto:</p><pre><code>$ sudo vde&#95;switch -tap tap0 -mod 660 -group kvm -daemon
$ sudo ip addr add 10.0.2.1/24 dev tap0
$ sudo ip link set dev tap0 up
$ sudo sysctl -w net.ipv4.ip&#95;forward=1
$ sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -j MASQUERADE</code></pre><p>La ĉi-supraj komandoj:</p><ol><li>Kreos la VDE-aparaton kreos;</li><li>Agordos la TCP/IP-opciojn por tiu aparato;</li><li>Ŝaltos la VDE-aparaton;</li><li>Ŝaltos La paketan plusendadon en la gastiga sistemo; kaj</li><li>Agordos la enkursigan agordon.</li></ol><h2><a name="rulo">Rulo</a></h2><h3><a name="sxargu">La bildon ŝargi</a></h3><p>Oni nun devas alvoki la komandon <code>qemu-kvm</code>—la komando kiu lanĉas ĉion. La nomo de la komando eble malsamas kun tiu, kiu instaliĝas ĉe la sistemo.</p><p>Se oni instalas operaciumon el praŝargebla bildo—kutime la ISO-dosiero—rulu la jenajn komandojn:</p><pre><code>$ sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio \
-net vde -soundhw all -vga qxl \
-spice port=9999,addr=127.0.0.1,password=sekretŝlosilo \
-boot once=d -cdrom installer.iso \
vm.qcow2</code></pre><p>Por sekvaj uzadoj:</p><pre><code>$ sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio \
-net vde -soundhw all -vga qxl \
-spice port=9999,addr=127.0.0.1,password=sekretŝlosilo \
vm.qcow2</code></pre><p>Ni malkomponu tiun:</p><pre><code>-cpu host</code></pre><p>Uzu la KVM-procezilon, per ĉiom da subtenitaj kapabloj.</p><pre><code>-m 2G</code></pre><p>Asignu 2GiB de gastiga maŝino por la gasto. Adaptu, kiel necese.</p><pre><code>-net nic,model=virtio -net vde</code></pre><p>Kreu virtualan NIC-adaptilo, kaj ŝaltu VDE-retkonektadon.</p><pre><code>-soundhw all</code></pre><p>Ŝaltu ĉiomajn aŭdiajn pelilojn.</p><pre><code>-vga qxl</code></pre><p>Precizigu la videan adaptilon por imiti. Uzu QXL kiam uzi SPICE.</p><pre><code>-spice addr=127.0.0.1,port=9999,password=sekretŝlosilo</code></pre><p>Precizigu la opciojn por SPICE, apartigitaj per komoj. <i>addr</i> kaj <i>port</i> estas la IP-adreso kaj TCP-pordo kiujn SPICE aŭskultos. Ideale, aliro al tiu pordo devas esti ĝuste agordita, kaj sekurigita. <i>password</i> etas la ŝlosilo, kiu estis uzota de la SPICE-kliento, <i>spicy</i>, por konekti al la gasta ekrano poste.</p><pre><code>-boot once=d -cdrom instalilo.iso</code></pre><p>Praŝargu komence el <code>instalilo.iso</code>, tiam por sekvontaj praŝargoj, praŝargu per la kutima ordo.</p><p>Kurante la <i>qemu-kvm</i>-komandon ĉi-supre, ŝargiĝos la bildon, tamen oni ne ankoraŭ povas vidi la ekranon.</p><h3><a name="ekrano">Konekti al la SPICE-ekrano</a></h3><p>Por ke oni povu uzi la gastan ekranon, oni devas konekti al la SPICE-servilo, per la SPICE-kliento:</p><pre><code>$ spicy -h 127.0.0.1 -p 9999 -w sekretŝlosilo</code></pre><p>Memoru, ke fermi la spicy-fenestron ne mortigos la QEMU-seancon. Se la gasta operaciumo kaptas la musenigon, premu <kbd>Shift+F12</kbd> por eskapi.</p><h3><a name="gastareto">La gastan reton agordi</a></h3><p>Sekve, oni devas ĝuste agordi la retan agordon de la gasta operaciumo, por ke ĝi povu konekti al la lokreto, kaj la interreto se la gastiga maŝino havas aliron al ĝi.</p><p>IP-adreso:</p><pre><code>10.0.2.2</code></pre><p>Implicita kluzo:</p><pre><code>10.0.2.1</code></pre><p>DNS-serviloj:</p><pre><code>8.8.8.8
8.8.4.4</code></pre><h2><a name="kurtenoj">La kurtenojn ferm</a></h2><h3><a name="restauxri">La retkonektadon restaŭri</a></h3><p>Se oni volas specife restaŭri la retkonektadon, rulu la jenajn komandojn:</p><pre><code class="sh">$ sudo iptables -t nat -D POSTROUTING -s 10.0.2.0/24 \
-j MASQUERADE
$ sudo sysctl -w net.ipv4.ip&#95;forward=0
$ sudo ip link set dev tap0 down
$ sudo ip link delete tap0
$ sudo pkill -9 vde&#95;switch
$ sudo rm -f /run/vde.ctl/ctl
</code></pre><p>La ĉi-supraj komandoj:</p><ol><li>Restaŭros la enkursigan agordon;</li><li>Malŝaltos la paketan plusendadon;</li><li>Malŝaltos La VDE-aparaton;</li><li>Forviŝos la VDE-aparaton;</li><li>Mortigos la VDE-procezon; kaj</li><li>Forviŝos la regajn dosierojn.</li></ol><h2><a name="cxio">Ĉion kolekti</a></h2><p>Jen ĉiom da komandoj de supre, kompiligitaj kiel funkcioj, por ke oni povu ruli ilin ĉe la komandlinio facile:</p><pre><code>function kvm-net &#40;&#41; {
  case $1 in
    up&#41;
      sudo vde&#95;switch -tap tap0 -mod 660 -group kvm -daemon
      sudo ip addr add 10.0.2.1/24 dev tap0
      sudo ip link set dev tap0 up
      sudo sysctl -w net.ipv4.ip&#95;forward=1
      sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
      ;;
    down&#41;
      sudo iptables -t nat -D POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
      sudo sysctl -w net.ipv4.ip&#95;forward=0
      sudo ip link set dev tap0 down
      sudo ip link delete tap0
      sudo pkill -9 vde&#95;switch
      sudo rm -f /run/vde.ctl/ctl
      ;;
  esac
}

function kvm-boot &#40;&#41; {
    sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio -net vde \
    -soundhw all -vga qxl \
    -spice port=9999,addr=127.0.0.1,disable-ticketing \
    $@
}

function kvm-iso &#40;&#41; {
    kvm-boot -boot once=d -cdrom $1 ${argv&#91;2,-1&#93;}
}

function kvm-display &#40;&#41; {
    spicy -p 9999 -h 127.0.0.1 -w sekretŝlosilo
}
</code></pre><p>Mi gvidos onin:</p><p>Komence, agordu la retkonektadon:</p><pre><code>$ kvm-net up</code></pre><p>Tiam,  ŝargu la bildon:</p><pre><code>$ kvm-boot vm.qcow2</code></pre><p>Fine, konektu al la ekrano:</p><pre><code>$ kvm-display</code></pre><p>Kiam oni finiĝas pri la virtuala maŝino, fermu la spice-ekranon, tiam malŝaltu la KVM-retkonektadon.</p><pre><code>$ kvm-net down</code></pre><h2><a name="finrimarkoj">Finrimarkoj</a></h2><p>QEMU subtenas miriadojn da mojosaj opcioj kiujn ni ne eĉ diskutis ĉi tie, inkluzive statojn konservi kaj ŝargi, ekranaj kaj aŭdiaj kaptoj, kaj plu. Por lerni pli pri ili, alklaku [ĉi tiun](http://wiki.qemu-project.org/Main_Page).</p><p>QEMU kun KVM estas potencaj, rapidaj, kaj flekseblaj solvoj por fari tutvirtualigadon. Almenaŭ en mia kazo, ĝi superas la plej konatajn opciojn en la bazaro. Se oni volas kontribui al ĉi tiu projekto, iru al ĝia <a href='https://github.com/qemu/qemu'>GitHub-paĝo</a>.</p><p>Mi esperas, ke ĉi tiu afiŝo helpis onin , iel aŭ aliel, lerni pli pri QEMU kaj KVM kaj kiujn ili povas doni.</p><hr/><div class="footer"><p><div class="text-small"> <a href='/eo/'>Hejmo</a> ∅ <a href='/eo/pri/'>Pri</a> ∅ <a href='/eo/citajxoj/'>Citaĵoj</a> ∅ <a href='/eo/pripensoj/'>Pripensoj</a> </div></p><p><div class="text-x-small"> Kreita en 🇵🇭 per ❤️ de Rommel Martínez </div></p><p></div></p></div><script src="/static/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>