<!DOCTYPE html>
<html lang="eo"><head><title>Virtualigado en Linukso per KVM</title><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0,user-scalable=yes" name="viewport" /><meta content="noodp,noydir" name="robots" /><meta content="Virtualigado en Linukso per KVM" name="description" /><meta content="kvm, qemu, linukso, virtualigado" name="keywords" /><meta content="Virtualigado en Linukso per KVM" property="og:title" /><meta content="article" property="og:type" /><meta content="https://ebzzry.io/eo/kvm/" property="og:url" /><meta content="https://ebzzry.io/static/ico/android-chrome-512x512.png" property="og:image" /><link href="/static/ico/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="/static/ico/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="/static/ico/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/static/ico/manifest.json" rel="manifest" /><link color="#5bbad5" href="/static/ico/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#ffffff" name="theme-color" /><style media="all" type="text/css">html {    color: #333;    font-size: 1em;    font-family: Georgia, Cambria, Palatino, "Palatino Linotype", "Times New Roman", Times, serif;    line-height: 1.45;    text-align: left:    width: 100%;    max-width: 40em;    margin: 0 auto 0 auto;    padding: 0;}body {    border-top: hidden;    border-bottom: hidden;    padding: 0 1.5em 1em 1.5em;    margin: 0;}#content {    -webkit-column-count: 1;    -moz-column-count: 1;    column-count: 1;}code {    font-size: 0.9em;    font-family: "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Lucida Console", "Courier New", Courier, monospace;    color: black;    display: inline-block;    font-weight: bold;}pre code {    font-size: 1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;    font-weight: normal;}kbd {    font-size: 1.1em;    padding: 0.1em 0.6em;    border: 1px solid #ccc;    font-family: monospace;    background-color: #f7f7f7;    color: #333;    -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -moz-border-radius: 3px;    -webkit-border-radius: 3px;    border-radius: 3px;    display: inline-block;    margin: 0 0.1em;    text-shadow: 0 1px 0 #fff;    white-space: nowrap;}h1, h2, h3, h4, h5, h6 {    font-family: Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans", Tahoma, Geneva, Helvetica, Arial, sans-serif;    margin-bottom: 0;}h1 {    font-size: 2.5em;    text-align: center;    border-bottom: 6px solid black;}h2 {    font-size: 2.0em;    text-align: left;    border-bottom: 2px solid black;}h3 {    font-size: 1.6em;    text-align: left;    border-bottom: 1px solid lightgrey;}h4 {    font-size: 1.5em;    text-align: left;}h5 {    font-size: 1.3em;    text-align: left;}ul, ol {    padding-left: 2em;}ul li {    list-style-type: square;}ul li li {    list-style-type: disc;}ul li li li {    list-style-type: circle;}ol li {    list-style-type: decimal;}p, para, b, strong, i, em, emph {    font-size: 1em;}blockquote {    font-size: 1.2em;    font-style: italic;    margin-left: 2em;}b, strong {    font-weight: bold;}i, em, emph {    font-style: italic;}table {    margin: 0.5em;    border-spacing: 0;    border-collapse: collapse;}th, td {    border: 1px solid lightgray;    padding-top: 0;    padding-bottom: 0;    padding-left: 0.45em;    padding-right: 0.45em;}.text-right {    text-align: right;}.text-small {    font-size: small;}.text-x-small {    font-size: x-small;}.banner {    display: block;    width: 100%;    margin-left: auto;    margin-right: auto;}.footer {    text-align: right;    float: right;    max-width: 18em;}.cc {    border-width: 0}.center {    text-align: center;}</style><style media="all" type="text/css">/* Ewan Themes -- based 99.99% from Tomorrow Night Theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Original theme - https://github.com/chriskempson/tomorrow-theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Tomorrow Comment */.hljs-comment {  color: #969896;}/* Tomorrow Red */.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo {  color: #cc6666;}/* Tomorrow Orange */.hljs-number,.hljs-preprocessor,.hljs-pragma,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant {  color: #de935f;}/* Tomorrow Yellow */.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute {  color: #f0c674;}/* Tomorrow Green */.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.hljs-name,.ruby .hljs-symbol,.xml .hljs-cdata {  color: #b5bd68;}/* Tomorrow Aqua */.hljs-title,.css .hljs-hexcolor {  color: #8abeb7;}/* Tomorrow Blue */.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title {  color: #81a2be;}/* Tomorrow Purple */.hljs-keyword,.javascript .hljs-function {  color: #b294bb;}.hljs {  display: block;  overflow-x: auto;  background: #1d1f21;  color: #c5c8c6;  padding: 0.5em;  -webkit-text-size-adjust: none;}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata {  opacity: 0.5;}pre code {    font-size: 1.1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;}</style></head><body><div id="content"><h1>Virtualigado en Linukso per KVM</h1><p><div class="center"><a href='#'>Esperante</a> · <a href='/en/kvm'>English</a></div> <div class="center">la 3-an de marto 2018</div> <div class="center">Laste ĝisdatigita: la 9-an de septembro 2018</div></p><blockquote><p>Se tion oni faras, kion oni ĉiam faras; tion oni akiros, kion oni ĉiam akiras.<br> ―Anthony ROBBINS </p></blockquote><p>La <a href='https://en.wikipedia.org/wiki/Full_virtualization'>tutvirtualigadajn</a> solvojn kiel «VMware Workstation», «Oracle VirtualBox», kaj «Parallels» plejmulto da oni konas. En ĉi tiu afiŝo, alian metodon por aferojn fari, mi reenkondukos al oni.</p><p>La <code>$</code> simbolo uzitos por la ŝelan inviton de normala uzanto indiki, dum la <code>#</code> simbolo uzitos por la ŝelan inviton de la ĉefuzanto indiki. Estas fojoj kiam la <a href='https://en.wikipedia.org/wiki/User_identifier#Effective_user_ID'>EUID</a> de komando estos nulo (0) pro la uzado de «sudo».</p><h2><a name="et"></a>Enhavotabelo</h2><ul><li><a href='#agordajxo'>Agordaĵo</a><ul><li><a href='#aparataro'>Aparataro</a></li><li><a href='#programaro'>Programaro</a></li></ul></li><li><a href='#agordo'>Agordo</a><ul><li><a href='#bildoj'>Bildoj</a></li><li><a href='#grupo'>KVM-grupo</a></li><li><a href='#retkonektado'>Retkonektado</a></li></ul></li><li><a href='#plenumo'>Plenumo</a><ul><li><a href='#sxargxu'>La bildon ŝarĝi</a></li><li><a href='#ekrano'>Konekti al la SPICE-ekrano</a></li><li><a href='#gastareto'>La gastan reton agordi</a></li></ul></li><li><a href='#kurtenoj'>La kurtenojn fermi</a><ul><li><a href='#restauxri'>La retkonektadon restaŭri</a></li></ul></li><li><a href='#cxio'>Ĉion kolekti</a></li><li><a href='#finrimarkoj'>Finrimarkoj</a></li></ul><h2><a name="agordajxo"></a>Agordaĵo</h2><h3><a name="aparataro"></a>Aparataro</h3><p>Unu el la plej unuaj aferoj kiujn oni devas fari estas por la <a href='https://en.wikipedia.org/wiki/Hardware-assisted_virtualization'>aparataro-asistitan virtualigadon</a> ŝalti, ankaŭ nomiĝas plirapigita virtualigado, en la aparataro. Se la ĉefprocezilo estis kreita antaŭ 2006, plej verŝajne, ĉi tiu kapablo ne ĉeestas en la ico. Ankaŭ, tenu en la kalkulo, ke ĉi tiu paŝo ne devigatas por iun ajn kapablojn en ĉi tiu afiŝo uzi, tamen la aferojn ĝi <i>atentinde</i> plirapidigos.</p><p>Por plirapigitan virtualigadon ŝalti, iru al la BIOS/UEFI agordoj, kaj la tenilon por ĉi tiun kapablon trovu. La nomo de ĉi tiu kapablo malsamas inter fabrikanto al fabrikanto. La agordon konservu, tiam la sistemon reŝarĝu. Tiam, la kapablon oni nun povas verigi komandlinie.</p><pre><code>$ egrep '&#40;vmx|svm&#41;' /proc/cpuinfo</code></pre><p>Se kelkajn tekstojn ĝi revenigas, oni bonas.</p><h3><a name="programaro"></a>Programaro</h3><p>Sekve, la havendajn apojn oni devas instali:</p><p>Nix:</p><pre><code>$ nix-env -i qemu vde2 spice&#95;gtk</code></pre><p>APT:</p><pre><code>$ sudo apt-get install -y qemu-kvm vde2 spice-client-gtk</code></pre><p>La <a href='http://wiki.qemu-project.org/Main_Page'>QEMU</a>-an /ki-mu/ hiperregilon, la <a href='http://vde.sourceforge.net/'>VDE</a>-ilojn, kaj <a href='http://www.spice-space.org/'>SPICE</a>-subtenon ĉi tio instalas. QEMU, almenaŭ dum siaj fruaj tagoj ne estis impresa—ĝi estis bona, bedaŭrinde ne bonegas. Ekde versio 0.10.1, na <a href='http://www.linux-kvm.org/'>KVM</a>-kapablojn—virtualigada subsistemo por linukso—kiu preskaŭ denaskan virtualigadon disponigas per aparataro-asistita virtualigado, QEMU komencis subteni. La rendimentojn de la aliaj virtualigadaj sistemoj menciitaj ĉi-supre ĝi eĉ konkuras.</p><p>La opcion de konekti al la gasta maŝina ekrano <a href='https://en.wikipedia.org/wiki/Virtual_Network_Computing'>VNC</a>-e aliaj aplikaĵaroj ofertas. Bedaŭrinde, ĝi malrapidas kaj malviglas. La respondtempo teruras. La <a href='http://www.spice-space.org/'>SPICE</a>-protokolon uzante, ne nur aferojn ĝi plirapidigas, ankaŭ aliajn aferojn ĝi ebligas. Tenu en la kalkulo, ke SPICE ne estas anstataŭaĵo por VNC, anstataŭe, ĝi estas alia maniero por la celojn renkonti.</p><h2><a name="agordo"></a>Agordo</h2><h3><a name="bildoj"></a>Bildoj</h3><p>Tabelon de bildaj tipoj QEMU subtenas, tamen la <a href='https://en.wikipedia.org/wiki/Qcow'>QCOW2</a>-formato estas la plej fleksebla, kaj kapable riĉas, por la uzo do QEMU.</p><p>Se ekzistantan VirtualBox-dosieron (VDI) oni havas, ĝin oni povas konverti al QCOW2 per:</p><pre><code>$ qemu-img convert -f vdi -O qcow2 vm.vdi vm.qcow2</code></pre><p>Tamen, se bildon oni ne jam havas, ĝin oni povas krei per:</p><pre><code>$ qemu-img create -f qcow2 vm.qcow2 20G</code></pre><p>20GiB-an bildon la lasta paŝo kreas, kiu nomiĝas <code>vm.qcow2</code>. Tenu en la kalkulo, ke la dosiersufikso ne fakte gravas—la bildon oni povas nomigi kiel <code>index.html</code>, tamen tio ne estus sencema, ĉu ne? 😄</p><h3><a name="grupo"></a>KVM-grupo</h3><p>La komandoj ĉi-sube postulas, ke grupo nomiĝas <code>kvm</code> devas ekzisti kaj oni estas ano de tiu grupo. Por tion efektivigi, kuru:</p><pre><code>$ sudo groupadd kvm
$ sudo usermod -G $&#40;groups | sed 's/ /,/g'&#41;,kvm $USER
$ newgrp kvm</code></pre><p>Onin la lasta komando varbas al la KVM-grupo senelsaluti el la seanco.</p><h3><a name="retkonektado"></a>Retkonektado</h3><p><a href='http://wiki.qemu-project.org/Documentation/Networking'>Multajn manierojn</a> de retkonektado agordi por siaj gastoj QEMU subtenas, tamen por ĉi tiu afiŝo nur na VDE ni uzos.</p><p>Kelkajn komandojn oni devas kuri por la retan medion pretigi. Ideale, la komandojn oni volas konservi en ŝela funkcio aŭ skripto:</p><pre><code>$ sudo vde&#95;switch -tap tap0 -mod 660 -group kvm -daemon
$ sudo ip addr add 10.0.2.1/24 dev tap0
$ sudo ip link set dev tap0 up
$ sudo sysctl -w net.ipv4.ip&#95;forward=1
$ sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -j MASQUERADE</code></pre><p>La ĉi-supraj komandoj:</p><ol><li>La VDE-aparaton kreos.</li><li>La TCP/IP-opciojn agordos por tiu aparato.</li><li>La VDE-aparaton ŝaltos.</li><li>La paketan plusendadon ŝaltos en la gastiga sistemo.</li><li>La enkursigan agordon agordos.</li></ol><h2><a name="plenumo"></a>Plenumo</h2><h3><a name="sxargxu"></a>La bildon ŝarĝi</h3><p>La komandon <code>qemu-kvm</code> oni nun devas alvoki, la komando kiu ĉion lanĉas. La nomo de la komando eble malsamas kun la tiu, kiu instalitas sur la sistemo.</p><p>Se operaciumon el praŝarĝebla bildo oni instalas, kutime la ISO-dosiero, kuru:</p><pre><code>$ sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio \
-net vde -soundhw all -vga qxl \
-spice port=9999,addr=127.0.0.1,password=sekretŝlosilo \
-boot once=d -cdrom installer.iso \
vm.qcow2</code></pre><p>En sekvaj uzadoj:</p><pre><code>$ sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio \
-net vde -soundhw all -vga qxl \
-spice port=9999,addr=127.0.0.1,password=sekretŝlosilo \
vm.qcow2</code></pre><p>Tion ni malkomponu:</p><pre><code>-cpu host</code></pre><p>La KVM-procezilon uzu, per ĉiom da subtenitaj kapabloj.</p><pre><code>-m 2G</code></pre><p>2GiB de gastiga maŝino por la gasto asignu. Adaptu, kiel necese.</p><pre><code>-net nic,model=virtio -net vde</code></pre><p>Virtualan NIC-on kreu, kaj VDE-retkonektadon ŝaltu.</p><pre><code>-soundhw all</code></pre><p>Ĉiom da aŭdia pelilo ŝaltu.</p><pre><code>-vga qxl</code></pre><p>La videan adaptilon por imiti precizigu. Na QXL uzu kiam na SPICE uzi.</p><pre><code>-spice addr=127.0.0.1,port=9999,password=sekretŝlosilo</code></pre><p>La opciojn por SPICE precizigu, apartigitaj per komoj.  <i>addr</i> kaj <i>port</i> estas la IP-adreso kaj TCP-pordo kiujn SPICE aŭskultos. Ideale, aliro al tiu pordo devas esti ĝuste agordita, kaj sekurigita. <i>password</i> etas la ŝlosilo, kiu esti uzota de la SPICE-kliento, <i>spicy</i>, por konekti al la gasta ekrano poste.</p><pre><code>-boot once=d -cdrom instalilo.iso</code></pre><p>Praŝarĝi komence el <code>instalilo.iso</code>, tiam por sekvontaj praŝarĝoj, praŝarĝu per la kutima ordo.</p><p>La <i>qemu-kvm</i>-komandon ĉi-supre kurante, la bildon ŝarĝos, tamen la ekranon oni ne ankoraŭ povas vidi.</p><h3><a name="ekrano"></a>Konekti al la SPICE-ekrano</h3><p>Por ke la gastan ekranon oni povu uzi, oni devas konekti al la SPICE-servilo, per la SPICE-kliento:</p><pre><code>$ spicy -h 127.0.0.1 -p 9999 -w sekretŝlosilo</code></pre><p>Tenu en la kalkulo, ke la spicy-fenestron fermi ne la QEMU-seancon mortigas. Se la musenigon la gasta operaciumo kaptas, na <kbd>Shift+F12</kbd> premu, por eskapi.</p><h3><a name="gastareto"></a>La gastan reton agordi</h3><p>Sekve, la retan agordon de la gasta operaciumo oni devas ĝuste agordi, por ke ĝi povu konekti al la lokreto, kaj la interreto se aliron al ĝi la gastiga maŝino havas.</p><p>IP-adreso:</p><pre><code>10.0.2.2</code></pre><p>Defaŭlta kluzo:</p><pre><code>10.0.2.1</code></pre><p>DNS-serviloj:</p><pre><code>8.8.8.8
8.8.4.4</code></pre><h2><a name="kurtenoj"></a>La kurtenojn fermi</h2><h3><a name="restauxri"></a>La retkonektadon restaŭri</h3><p>Se la retkonektadon oni volas specife restaŭri, la jenan faru.</p><pre><code class="bash">$ sudo iptables -t nat -D POSTROUTING -s 10.0.2.0/24 \
-j MASQUERADE
$ sudo sysctl -w net.ipv4.ip&#95;forward=0
$ sudo ip link set dev tap0 down
$ sudo ip link delete tap0
$ sudo pkill -9 vde&#95;switch
$ sudo rm -f /run/vde.ctl/ctl
</code></pre><p>La ĉi-supraj komandoj:</p><ol><li>La enkursigan agordon restaŭros.</li><li>La paketan plusendadon malŝaltos.</li><li>La VDE-aparaton malŝaltos.</li><li>La VDE-aparaton forviŝos.</li><li>La VDE-procezon mortigos.</li><li>La regajn dosierojn forviŝos.</li></ol><h2><a name="cxio"></a>Ĉion kolekti</h2><p>Jen ĉiom da komando el supre, kompiligitaj kiel funkcioj, por ke ilin oni povu kuri komandlinie:</p><pre><code>function kvm-net &#40;&#41; {
  case $1 in
    up&#41;
      sudo vde&#95;switch -tap tap0 -mod 660 -group kvm -daemon
      sudo ip addr add 10.0.2.1/24 dev tap0
      sudo ip link set dev tap0 up
      sudo sysctl -w net.ipv4.ip&#95;forward=1
      sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
      ;;
    down&#41;
      sudo iptables -t nat -D POSTROUTING -s 10.0.2.0/24 -j MASQUERADE
      sudo sysctl -w net.ipv4.ip&#95;forward=0
      sudo ip link set dev tap0 down
      sudo ip link delete tap0
      sudo pkill -9 vde&#95;switch
      sudo rm -f /run/vde.ctl/ctl
      ;;
  esac
}

function kvm-boot &#40;&#41; {
    sudo qemu-kvm -cpu host -m 2G -net nic,model=virtio -net vde \
    -soundhw all -vga qxl \
    -spice port=9999,addr=127.0.0.1,disable-ticketing \
    $@
}

function kvm-iso &#40;&#41; {
    kvm-boot -boot once=d -cdrom $1 ${argv&#91;2,-1&#93;}
}

function kvm-display &#40;&#41; {
    spicy -p 9999 -h 127.0.0.1 -w sekretŝlosilo
}
</code></pre><p>Onin mi gvidos:</p><p>Komence, la retkonektadon agordu:</p><pre><code>$ kvm-net up</code></pre><p>Tiam, la bildon ŝarĝu:</p><pre><code>$ kvm-boot vm.qcow2</code></pre><p>Fine, konektu al la ekrano:</p><pre><code>$ kvm-display</code></pre><p>Kiam oni finiĝas kun la virtuala maŝino, la spice-ekranon fermu, tiam la KVM-retkonektado malŝaltu.</p><pre><code>$ kvm-net down</code></pre><h2><a name="finrimarkoj"></a>Finrimarkoj</h2><p>Miriadojn de mojosaj opcioj kiujn ni ne eĉ diskutis ĉi tie QEMU subtenas, inkluzive statojn konservi kaj ŝarĝi, ekranaj kaj aŭdiaj kaptoj, kaj plu. Por lerni pli pri ili, <a href='http://wiki.qemu-project.org/Main_Page'>ĉi tien</a> klaku.</p><p>QEMU kun KVM estas potenca, rapida, kaj fleksebla solvo por tutvirtualigadon fari. Almenaŭ en mia kazo, la plej konatajn opciojn en la bazaro ĝi superas. Se oni volas kontribui al ĉi tiu projekto, iru al ĝia <a href='https://github.com/qemu/qemu'>GitHub-paĝo</a>.</p><p>Mi esperas, ke onin ĉi tiu afiŝo helpis, iel aŭ aliel, lerni pli pri QEMU kaj KVM kaj kiujn ili povas doni.</p><hr/><div class="footer"><p><div class="text-small"> <a href='/eo'>Hejmo</a> · <a href='/eo/pri'>Pri</a> · <a href='/eo/citajxoj'>Citaĵoj</a> · <a href='/eo/pripensoj'>Pripensoj</a> · <a href='https://github.com/ebzzry/ebzzry.github.io'>Fonto</a> </div> <div class="text-x-small"> Kreitis per <a href='https://github.com/ebzzry/emem'>emem</a> </div></p><p><div class="text-x-small"> <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.eo"><img alt="CC0 1.0 Universala (CC0 1.0) Publikaĵiga Dediĉo" class="cc" src="/bil/cc0-88x31.png" /></a><br> Ĉi tiu verko estas <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.eo">publika havaĵo.</a><br> </div></p><p></div></p></div><script src="/static/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-93746003-1', 'auto');ga('send', 'pageview');</script></body></html>